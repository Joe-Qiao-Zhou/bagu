# 概述

- 网络时延=排队+处理+传输+传播

# 体系结构

- | OSI                                             | 五层协议 | TCP/IP   |
  | ----------------------------------------------- | -------- | -------- |
  | 应用（报文）应用间                              | 应用     | 应用     |
  | 表示                                            | 应用     | 应用     |
  | 会话                                            | 应用     | 应用     |
  | 传输层（报文段segment用户数据报datagram）进程间 | 传输     | 传输     |
  | 网络层（IP数据包packet）主机间                  | 网络     | 网际     |
  | 数据链路层（帧frame）主机间链路                 | 数据链路 | 网络接口 |
  | 物理层（比特流）                                | 物理     | 网络接口 |

# 物理层

- 通信方式：单工（单向）、半双工（双向交替）、全双工（双向同时）
- 带通调制：数字信号转换为模拟信号，数字信号带宽**小于**模拟信号（只有0和1）

# 数据链路层

- 封装成帧：IP数据包+首部+尾部

- 透明传输：转义字符用来转义和首尾相同的内容

- 差错检测：循环冗余校验CRC

- 信道分类

  - 广播信道
    - 信道复用：频分复用（相同时间占用不同带宽）、时分复用（不同时间占用相同带宽）、统计时分复用（不平分时间）、波分复用、码分复用
    - CSMA/CD：多点接入（总线型网络）、载波监听（一直监听）、碰撞检测（2τ争用期，截断二进制指数退避算法）
  - 点对点信道
    - PPP协议（主机与ISP通信）

- MAC地址：48位，标记网卡

  | 6        | 6      | 2            | 46-1500   | 4             |
  | -------- | ------ | ------------ | --------- | ------------- |
  | 目的地址 | 源地址 | 上层协议类型 | IP packet | 帧检验序列FCS |

- 交换机：自学习**交换表**，保存MAC地址到接口的映射

# 网络层

- 向上提供简单灵活、无连接、尽最大努力交互的IP数据报服务

- 配套协议

  - 地址解析协议ARP
  - 网际控制报文协议ICMP
  - 网际组管理协议IGMP

- IP数据报格式

  ![image-20220509152742028](C:\Users\91494\AppData\Roaming\Typora\typora-user-images\image-20220509152742028.png)

  - 版本：4和6
  - 首部长度：单位为4字节，最小为5，最大为15
  - 区分服务：一般不使用
  - 总长度：首部+数据部分
  - 生存时间：TTL，路由器跳数，0就丢弃
  - 协议：ICMP、TCP、UDP等
  - 首部检验和：不包含数据部分，每个路由器都要重新计算
  - 标识：相同数据报的不同分片标识符相同
  - 片偏移：单位为8字节

- IP地址编址方式

  - 分类：网络号+主机号
    - A类地址：8位网络号0+24位主机号
    - B类地址：16位网络号10+16位主机号
    - C类地址：24位网络号110+8位主机号
    - D类地址：1110+多播地址
    - E类地址：1111+保留今后使用
  - 子网划分：网络号+子网号+主机号，外部网络不可见
  - 无分类编址CIDR：网络前缀号+主机号
    - 路由聚合/构成超网：通过网络前缀减少路由表项

- ARP：由IP得到MAC
  - 每个主机都有ARP高速缓存，保存**本局域网各主机和路由器I**P到MAC的映射表
  - 广播ARP请求分组，回复ARP响应分组

- ICMP
  - ping：测试主机间连通性，通过`ICMP Echo请求 询问报文`和`ICMP Echo回答 询问报文`实现
  - traceroute：跟踪源终点路径，通过`无法交付的UDP用户数据报`+`递增TTL`+`ICMP 时间超过 差错报告报文`+`ICMP 终点不可达 差错报告报文`实现
- VPN
  - 专用地址块：10.0.0.0-10.255.255.255，172.16.0.0-172.31.255.255，192.168.0.0-192.168.255.255
- NAT/NAPT：使用内部IP地址与互联网通信，将本地IP转换为全球IP

- 路由器
  - 路由选择+分组转发（交换结构+输入端口+输出端口）
  - 分组转发流程
    1. 提取目的主机，得到目的网络地址
    2. 如果是路由器直连网络地址，直接交付
    3. 如果路由表中有对应特定主机路由，转发给下一跳路由器
    4. 如果路由表中有目的网络路由，转发
    5. 如果有默认路由，转发
    6. 转发出错
  - 路由选择协议
    - AS内部路由选择
      - RIP：基于距离向量（跳数），固定时间间隔和相邻路由器交换路由表
      - OSPF：基于路径，链路状态变化时和所有路由器交换相邻路由器链路状态
    - AS间路由选择
      - BGP：寻找较好路由

# 传输层

- | UDP                                     | TCP          |
  | --------------------------------------- | ------------ |
  | 无连接                                  | 面向连接     |
  | 尽最大可能交付                          | 可靠交付     |
  | 无拥塞控制                              | 有拥塞控制   |
  | 面向报文（不拆分不合并，只添加UDP首部） | 面向字节流   |
  | 支持多种通信方式                        | 只支持一对一 |

- UDP首部：12字节伪首部+2字节源端口+2字节目的端口+2字节长度+2字节检验和

- TCP首部

  ![image-20220509155654948](C:\Users\91494\AppData\Roaming\Typora\typora-user-images\image-20220509155654948.png)

  - 序号：对字节流编号，表示起始字节
  - 确认号：期望收到的下一个报文段序号
  - 数据偏移：首部长度
  - ACK：1时确定号有效，连接建立后**所有**报文段ACK=1

- 三次握手

  ![image-20220509160014941](C:\Users\91494\AppData\Roaming\Typora\typora-user-images\image-20220509160014941.png)

  - 第三次握手原因：防止失效连接请求和超时重传请求使服务器打开两个连接

- 四次挥手

  ![image-20220509160148615](C:\Users\91494\AppData\Roaming\Typora\typora-user-images\image-20220509160148615.png)

  - TIME-WAIT原因：确保最后一个确认能到达，若没到达则会重新发送请求；并确保本连接的所有报文消失

- 可靠传输：通过超时重传实现

- 滑动窗口：接收窗口只对窗口内最后一个按序到达字节进行确认

- 流量控制：通过接收方的窗口字段控制发送方的发送速率，使接收方来得及接收
- 拥塞控制：控制发送方的重传速率，使网络拥塞程度降低；发送方维护拥塞窗口cwnd
  1. 慢开始和拥塞避免：`cwnd=1`，每次确认窗口加倍，当`cwnd>=ssthresh`时进入拥塞避免，若超时`ssthresh=cwnd/2，cwnd=1`
  2. 快重传和快恢复：接收方对每次收到的最后一个有序报文段进行确认；发送方若收到3个重复确认，执行快重传--立即重传下一个报文段，执行快恢复--`ssthresh=cwnd/2，cwnd=ssthresh`

# 应用层

- DNS是分布式数据库，提供主机名和IP地址相互转换，分为根域名、顶级域名和二级域名

- 大多数情况使用UDP传输，端口号53

- 文件传送协议FTP：控制连接使用21号端口，根据数据连接建立方式，FTP分为主动和被动模式

  - 主动模式：服务器主动建立数据连接，服务器端口号20，客户端端口号>1024
  - 被动模式：客户端主动建立数据连接

- 动态主机配置协议DHCP：即插即用，不需要配置IP地址、子网掩码和网关IP

  1. 客户端发送Discover报文，目的地址为全1，67号端口，源地址为全0，68号端口，UDP传输到同一子网所有主机上
  2. DHCP服务器收到后发送Offer报文
  3. 客户端发送Request报文给选择的DHCP服务器
  4. 服务器发送Ack报文

- 远程登录协议TELNET

- 电子邮件协议：发送协议SMTP，读取协议POP3（只要用户从服务器读取了邮件就删除）和IMAP（CS邮件保持同步）

- 应用层常用协议

  | 应用             | 协议   | 端口号  | 传输层协议 | 备注               |
  | ---------------- | ------ | ------- | ---------- | ------------------ |
  | 域名解析         | DNS    | 53      | UDP/TCP    | 超过512字节使用TCP |
  | 动态主机配置协议 | DHCP   | 68/67   | UDP        |                    |
  | 简单网络管理协议 | SNMP   | 161/162 | UDP        |                    |
  | 文件传送协议     | FTP    | 21/20   | TCP        |                    |
  | 远程终端协议     | TELNET | 23      | TCP        |                    |
  | 超文本传送协议   | HTTP   | 80      | TCP        |                    |
  | 简单邮件传送协议 | SMTP   | 25      | TCP        |                    |
  | 邮件读取协议     | POP3   | 110     | TCP        |                    |
  | 网际报文存取协议 | IMAP   | 143     | TCP        |                    |

## Web页面请求过程

1. 若主机无IP地址，则通过DHCP获取
   1. DHCP请求报文-->源端口68、目的端口67的UDP报文段-->源IP全0、目的端口全1的IP数据报-->目的MAC全1的帧，广播到交换机相连的子网
   2. DHCP服务器收到帧后，发送DHCP ack报文：IP地址+DNS服务器IP地址+默认网关IP地址+子网掩码-->UDP报文段-->IP数据报-->主机的MAC地址
2. ARP解析MAC地址
   1. 主机通过浏览器生成TCP套接字，套接字向HTTP服务器发送请求，需要知道域名对应的IP地址
   2. 主机生成DNS查询报文，端口为53，目的IP为DNS服务器IP
   3. MAC帧发送到网关路由器
   4. 由于DHCP只知道网关IP不知道网关MAC，需要使用ARP：主机生成目的IP为网关IP、目的MAC为全1的MAC帧
   5. 网关将MAC发回给主机
3. DNS解析域名
   1. 网关将IP数据报转发到响应路由
   2. 到达DNS服务器后查找待解析域名的IP，发回主机
4. HTTP请求页面
   1. 与HTTP服务器三次握手建立连接，端口为80
   2. 连接建立后，浏览器生成HTTP GET报文发给服务器
   3. 服务器从socket中读取报文，生成HTTP响应报文，将web页面放入其中发回
   4. 浏览器收到响应后抽取web页面内容，渲染显示